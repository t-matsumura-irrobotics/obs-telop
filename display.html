<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>OBS Telop Display</title>
    <link href="https://fonts.googleapis.com/css2?family=Anton&display=swap" rel="stylesheet">
    <style>
        @font-face { font-family: 'LINE Seed JP'; src: url('fonts/LINESeedJP_OTF_Rg.woff2') format('woff2'); font-weight: 400; }
        @font-face { font-family: 'LINE Seed JP'; src: url('fonts/LINESeedJP_OTF_Bd.woff2') format('woff2'); font-weight: 700; }
        
        /* ▼▼▼ html, body の修正 ▼▼▼ */
        html, body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'LINE Seed JP', sans-serif;
            height: 100%; /* これを明示的に指定することで、fixedが正しく動作します */
            width: 100%;
            background: transparent;
        }
        /* ▲▲▲ html, body の修正 ▲▲▲ */

        body { position: relative; }
        
        @keyframes seamless-scroll {
            from { transform: translateX(0); }
            to { transform: translateX(-50%); }
        }

        @keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-15px); } 60% { transform: translateY(-7px); } }

        /* ▼▼▼ telop-wrapper と clock-wrapper の追加修正 ▼▼▼ */
        .telop-wrapper {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            opacity: 0;
            transition: opacity 0.4s ease-out;
            display: none;
            z-index: 1000; /* 他の要素より手前に表示されるように */
        }
        .telop-wrapper.visible { opacity: 1; display: block; }

        /* 時報専用のラッパーを追加 */
        .clock-wrapper {
            position: fixed;
            bottom: 0; /* 画面下部に固定 */
            right: 0;  /* 画面右端に固定 */
            opacity: 0;
            transition: opacity 0.4s ease-out;
            display: none;
            z-index: 1001; /* ティッカーより少し上に */
        }
        .clock-wrapper.visible { opacity: 1; display: flex; /* flexboxで中央寄せ */ }
        /* ▲▲▲ telop-wrapper と clock-wrapper の追加修正 ▲▲▲ */
        
        #ticker-container { height: 96px; overflow: hidden; position: relative; background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        #ticker-header { position: absolute; left: 0; top: 0; z-index: 10; width: 300px; height: 100%; color: white; display: flex; align-items: center; justify-content: flex-start; background: linear-gradient(135deg, #ed949f, #69aef3); clip-path: polygon(0 0, 100% 0, 90% 100%, 0% 100%); font-size: 52px; font-weight: 700; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); padding-left: 30px; box-shadow: 5px 0 15px rgba(0,0,0,0.2); }
        #ticker-header-text { white-space: nowrap; transform-origin: left center; }
        
        /* ▼▼▼ 時報部分のCSSを修正しました ▼▼▼ */
        #ticker-clock { 
            /* #ticker-clock 自体は clock-wrapper の子になるので、position: absolute; は不要 */
            /* width: 162px; */ /* 幅は clock-wrapper で調整 */
            height: 100%; 
            background: linear-gradient(45deg, #ed949f, #69aef3); 
            color: white; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-size: 46px; 
            font-family: 'Anton', sans-serif; 
            box-shadow: -5px 0 15px rgba(0,0,0,0.2); 
            overflow: hidden;
            padding: 0 20px; /* 左右にパディングを追加して幅を確保 */
            min-width: 120px; /* 最小幅を確保 */
            box-sizing: border-box; /* paddingを含めた幅にする */
        }
        /* ▲▲▲ 時報部分のCSSを修正しました ▲▲▲ */

        #ticker-scroll-area { position: absolute; left: 280px; right: 162px; top: 0; height: 100%; overflow: hidden; }

        #ticker-scroll-container {
            display: flex;
            width: fit-content;
            animation-name: seamless-scroll;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
            animation-duration: var(--scroll-duration, 30s);
        }
        .ticker-content {
            display: block;
            white-space: nowrap;
            font-size: 40px;
            color: #333;
            padding: 0 20px;
            line-height: 96px;
        }
        
        #clock-time, #clock-live { position: absolute; width: 100%; text-align: center; transition: transform 0.4s ease; }
        #clock-live { transform: translateX(200%); font-size: 55px; font-style: italic; }
        #ticker-clock.show-live #clock-time { transform: translateX(-200%); }
        #ticker-clock.show-live #clock-live { transform: translateX(0); }
        #clock-live span { display: inline-block; animation: bounce 1.5s infinite ease-in-out; }
        #clock-live span:nth-child(1) { animation-delay: 0.1s; }
        #clock-live span:nth-child(2) { animation-delay: 0.2s; }
        #clock-live span:nth-child(3) { animation-delay: 0.3s; }
        #clock-live span:nth-child(4) { animation-delay: 0.4s; }

        #breaking-container-inner { background: #e0e0e0; border-radius: 8px; border-left: 8px solid #c00000; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .breaking-row { display: flex; font-weight: bold; }
        .br-row1-header { background: #e0e0e0; color: #000; font-size: 48px; padding: 10px 30px; white-space: nowrap; }
        .br-row1-main { background: #c00000; color: white; font-size: 48px; padding: 10px 30px; flex: 1; text-align: center; }
        .br-row2 { background: #222; color: white; font-size: 42px; padding: 8px 0; display: flex; }
        .br-row2-item { flex: 1; text-align: center; padding: 0 10px; }
        .br-row2-item + .br-row2-item { border-left: 2px solid #555; }
        .br-row2-item-value { background: white; color: #000; padding: 0 15px; margin: 0 10px; border-radius: 4px; display: inline-block; }
        .br-row3-header { background: #757575; color: white; font-size: 42px; padding: 8px 30px; white-space: nowrap; }
        .br-row3-main { background: #e0e0e0; color: #000; font-size: 42px; padding: 8px 30px; flex: 1; }
    </style>
</head>
<body>
    <div id="ticker-main-wrapper" class="telop-wrapper">
        <div id="ticker-container">
            <div id="ticker-header"><span id="ticker-header-text"></span></div>
            <div id="ticker-scroll-area">
                <div id="ticker-scroll-container">
                    <div class="ticker-content"></div>
                    <div class="ticker-content" aria-hidden="true"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="clock-display-wrapper" class="clock-wrapper">
        <div id="ticker-clock">
            <span id="clock-time">00:00</span>
            <span id="clock-live"><span>L</span><span>I</span><span>V</span><span>E</span></span>
        </div>
    </div>
    <div id="breaking-container" class="telop-wrapper">
        <div id="breaking-container-inner">
            <div class="breaking-row br-row1">
                <div id="br-r1-h" class="br-row1-header"></div>
                <div id="br-r1-m" class="br-row1-main"></div>
            </div>
            <div class="br-row2">
                <div id="br-r2-i1" class="br-row2-item"></div>
                <div id="br-r2-i2" class="br-r2-item"></div>
                <div id="br-r2-i3" class="br-r2-item"></div>
                <div id="br-r2-i4" class="br-r2-item"></div>
            </div>
            <div class="breaking-row br-row3">
                <div id="br-r3-h" class="br-row3-header"></div>
                <div id="br-r3-m" class="br-row3-main"></div>
            </div>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAhsAbTqQuairo-82A9rxQTazUCGdzdVc4",
            authDomain: "obs-telop-system-7c98c.firebaseapp.com",
            databaseURL: "https://obs-telop-system-7c98c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "obs-telop-system-7c98c",
            storageBucket: "obs-telop-system-7c98c.appspot.com",
            messagingSenderId: "368503557333",
            appId: "1:368503557333:web:409dae2b1cf0c14b31a65c",
            measurementId: "G-VMBCJ2952Z"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // (時計のロジックは変更ありません)
        const clockTimeEl = document.getElementById('clock-time');
        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            clockTimeEl.textContent = `${hours}:${minutes}`;
        }
        updateClock();
        setInterval(updateClock, 1000);

        database.ref('live_data').on('value', (snapshot) => {
            const data = snapshot.val();
            const tickerMainWrapper = document.getElementById('ticker-main-wrapper'); // ティッカー本体
            const breakingContainer = document.getElementById('breaking-container'); // 緊急速報
            const clockDisplayWrapper = document.getElementById('clock-display-wrapper'); // 時報

            if (!data) {
                tickerMainWrapper.classList.remove('visible');
                breakingContainer.classList.remove('visible');
                clockDisplayWrapper.classList.remove('visible');
                return;
            }

            // 時報の表示・非表示を常にチェック
            clockDisplayWrapper.classList.toggle('visible', !!data.showClock);

            if (data.mode === 'ticker') {
                breakingContainer.classList.remove('visible');
                tickerMainWrapper.classList.add('visible'); // ティッカー本体は表示
                
                document.getElementById('ticker-header-text').textContent = data.ticker_content.headerText;
                
                const tickerContents = document.querySelectorAll('.ticker-content');
                const scrollContainer = document.getElementById('ticker-scroll-container');

                tickerContents.forEach(el => {
                    el.textContent = data.ticker_content.scrollText;
                });
                
                scrollContainer.style.animationName = 'none';
                requestAnimationFrame(() => {
                    scrollContainer.style.animationName = 'seamless-scroll';
                });

                let baseDuration;
                switch (data.ticker_content.scrollSpeed) {
                    case 'speed-slow': baseDuration = 50; break;
                    case 'speed-fast': baseDuration = 20; break;
                    default: baseDuration = 35; break;
                }
                const textLength = data.ticker_content.scrollText.length;
                const adjustedDuration = Math.max(10, baseDuration * (textLength / 30));
                scrollContainer.style.setProperty('--scroll-duration', `${adjustedDuration}s`);

                // 時報内のLIVE表示は、ティッカーのisLive設定に連動
                document.getElementById('ticker-clock').classList.toggle('show-live', !!data.ticker_content.isLive);

            } else if (data.mode === 'breaking') {
                tickerMainWrapper.classList.remove('visible'); // ティッカー本体は非表示
                breakingContainer.classList.add('visible'); // 緊急速報は表示
                
                const b = data.breaking_content;
                document.getElementById('br-r1-h').textContent = b.b_r1_h;
                document.getElementById('br-r1-m').textContent = b.b_r1_m;
                document.getElementById('br-r2-i1').textContent = b.b_r2_i1;
                document.getElementById('br-r2-i2').textContent = b.b_r2_i2;
                document.getElementById('br-r2-i3').textContent = b.b_r2_i3;
                document.getElementById('br-r2-i4').textContent = b.b_r2_i4;
                document.getElementById('br-r3-h').textContent = b.b_r3_h;
                document.getElementById('br-r3-m').textContent = b.b_r3_m;
            } else {
                // どのモードでもない場合はすべて非表示
                tickerMainWrapper.classList.remove('visible');
                breakingContainer.classList.remove('visible');
            }
        });
    </script>
</body>
</html>