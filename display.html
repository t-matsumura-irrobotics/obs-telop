<!-- display.html (最終修正版) -->
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>OBS Telop Display</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Anton&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body class="obs-display">
    <div id="canvas">
        <div id="ticker-container" class="telop-wrapper">
            <div id="ticker-base-white"></div>
            <!-- ▼▼▼ 変更点: スクロール用レイヤーを2つ配置 ▼▼▼ -->
            <div id="ticker-scroll-area">
                <span id="ticker-content-A" class="ticker-content"></span>
                <span id="ticker-content-B" class="ticker-content"></span>
            </div>
            <!-- ▲▲▲ ここまで ▲▲▲ -->
            <div id="ticker-header"><span id="ticker-header-text"></span></div>
            <div id="ticker-clock"><span id="clock-time"></span><span id="clock-live"><span>L</span><span>I</span><span>V</span><span>E</span></span></div>
        </div>
        <div id="breaking-container" class="telop-wrapper">
            <div id="breaking-container-inner">
                <div id="top-bar" class="top-bar"><div id="header" class="top-bar-header"></div><div id="companyName" class="top-bar-main"></div></div>
                <div class="bottom-bar"><span id="detailText"></span></div>
            </div>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyAhsAbTqQuairo-82A9rxQTazUCGdzdVc4", authDomain: "obs-telop-system-7c98c.firebaseapp.com", databaseURL: "https://obs-telop-system-7c98c-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "obs-telop-system-7c98c", storageBucket: "obs-telop-system-7c98c.appspot.com", messagingSenderId: "368503557333", appId: "1:368503557333:web:409dae2b1cf0c14b31a65c", measurementId: "G-VMBCJ2952Z" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- 全要素を取得 ---
        const tickerContainer = document.getElementById('ticker-container'), breakingContainer = document.getElementById('breaking-container');
        const tickerHeader = document.getElementById('ticker-header'), tickerHeaderText = document.getElementById('ticker-header-text'), tickerClock = document.getElementById('ticker-clock');
        const topBar = document.getElementById('top-bar'), header = document.getElementById('header'), companyName = document.getElementById('companyName'), detailText = document.getElementById('detailText');

        // ▼▼▼ 新しいダブル・バッファリングのロジック ▼▼▼
        const bufferA = document.getElementById('ticker-content-A');
        const bufferB = document.getElementById('ticker-content-B');
        let activeBuffer = bufferA;
        let inactiveBuffer = bufferB;
        let currentScrollText = null;

        // 時計とヘッダーの補助関数
        function updateClock() {
            const now = new Date(); const s = now.getSeconds();
            document.getElementById('clock-time').textContent = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            if (s >= 30) { tickerClock.classList.add('show-live'); } else { tickerClock.classList.remove('show-live'); }
        }
        setInterval(updateClock, 1000); updateClock();

        function adjustHeaderText() {
            tickerHeaderText.style.transform = 'scaleX(1)';
            const containerWidth = tickerHeader.clientWidth - 40;
            const textWidth = tickerHeaderText.scrollWidth;
            if (textWidth > containerWidth) { tickerHeaderText.style.transform = `scaleX(${containerWidth / textWidth})`; }
        }

        database.ref('live_data').on('value', (snapshot) => {
            const data = snapshot.val();
            if (!data) return;

            if (data.mode === 'breaking' && data.breaking_content) {
                const content = data.breaking_content;
                // 速報テロップの表示処理
                // ... (省略) ...
                tickerContainer.classList.remove('visible');
                breakingContainer.classList.add('visible');
            } else {
                const content = data.ticker_content || {};
                tickerHeaderText.innerText = content.headerText || '東京株式市場';
                const newScrollText = content.scrollText || 'コメントをお待ちしています。';

                // テキストが変更された場合のみ、裏側のバッファを更新して入れ替える
                if (newScrollText !== currentScrollText) {
                    currentScrollText = newScrollText;
                    inactiveBuffer.innerText = `${currentScrollText}${currentScrollText}`;
                    
                    activeBuffer.classList.remove('active');
                    inactiveBuffer.classList.add('active');

                    // バッファの役割を交代
                    [activeBuffer, inactiveBuffer] = [inactiveBuffer, activeBuffer];
                }
                
                breakingContainer.classList.remove('visible');
                tickerContainer.classList.add('visible');
                setTimeout(adjustHeaderText, 50);
            }
        });
        // ▲▲▲ ロジックの変更ここまで ▲▲▲
    </script>
</body>
</html>