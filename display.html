<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>OBS Telop Display</title>
    <link href="https://fonts.googleapis.com/css2?family=Anton&display=swap" rel="stylesheet">
    <style>
        /* フォント定義 */
        @font-face { font-family: 'LINE Seed JP'; src: url('fonts/LINESeedJP_OTF_Rg.woff2') format('woff2'); font-weight: 400; }
        @font-face { font-family: 'LINE Seed JP'; src: url('fonts/LINESeedJP_OTF_Bd.woff2') format('woff2'); font-weight: 700; }

        /* 基本設定 */
        :root { --ticker-height: 96px; }
        html, body {
            margin: 0; padding: 0;
            width: 1920px; height: 1080px;
            font-family: 'LINE Seed JP', sans-serif;
            background: transparent;
            overflow: hidden;
        }
        body { position: relative; }

        /* アニメーション */
        @keyframes seamless-scroll {
            from { transform: translateX(0); }
            to { transform: translateX(-50%); }
        }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-15px); } 60% { transform: translateY(-7px); } }

        /* ラッパー（表示/非表示の制御） */
        .telop-wrapper {
            position: absolute;
            bottom: 20px; left: 20px; right: 20px;
            opacity: 0;
            transition: opacity 0.4s ease-out;
            visibility: hidden;
        }
        .telop-wrapper.visible {
            opacity: 1;
            visibility: visible;
        }

        /* ▼▼▼ ティッカー全体のレイアウトをFlexboxで再構築 ▼▼▼ */
        #ticker-container {
            height: var(--ticker-height);
            border-radius: 8px;
            background: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: flex; /* Flexboxレイアウトに変更 */
            overflow: hidden;
        }

        #ticker-header {
            flex-shrink: 0; /* 縮まないように設定 */
            width: 300px;
            height: 100%;
            color: white;
            display: flex;
            align-items: center;
            background: linear-gradient(135deg, #ed949f, #69aef3);
            clip-path: polygon(0 0, 100% 0, 90% 100%, 0% 100%);
            font-size: 52px;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            padding-left: 30px;
        }
        #ticker-header-text {
            white-space: nowrap;
            transform-origin: left center;
        }

        /* スクロールエリア */
        #ticker-scroll-area {
            flex-grow: 1; /* 残りの幅をすべて埋める */
            height: 100%;
            overflow: hidden;
            position: relative; /* 子要素の基準に */
        }
        #ticker-scroll-container {
            display: flex;
            width: fit-content;
            position: absolute;
            top: 0; left: 0;
            height: 100%;
            align-items: center; /* 上下中央揃え */
            animation: seamless-scroll linear infinite;
            animation-duration: var(--scroll-duration, 30s);
        }
        .ticker-content {
            white-space: nowrap;
            font-size: 40px;
            color: #333;
            padding: 0 25px; /* テキスト間の余白 */
        }

        /* 時計 */
        #ticker-clock {
            flex-shrink: 0; /* 縮まないように設定 */
            width: 162px;
            height: 100%;
            background: linear-gradient(45deg, #ed949f, #69aef3);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 46px;
            font-family: 'Anton', sans-serif;
            box-shadow: -5px 0 15px rgba(0,0,0,0.2);
            overflow: hidden;
            position: relative;
        }
        /* ▲▲▲ ティッカー全体のレイアウトをFlexboxで再構築 ▲▲▲ */

        /* 時計アニメーション */
        #clock-time, #clock-live {
            position: absolute;
            width: 100%;
            text-align: center;
            transition: transform 0.4s ease;
        }
        #clock-live {
            transform: translateX(200%);
            font-size: 55px;
            font-style: italic;
        }
        #ticker-clock.show-live #clock-time { transform: translateX(-200%); }
        #ticker-clock.show-live #clock-live { transform: translateX(0); }
        #clock-live span { display: inline-block; animation: bounce 1.5s infinite ease-in-out; }
        #clock-live span:nth-child(1) { animation-delay: 0.1s; }
        #clock-live span:nth-child(2) { animation-delay: 0.2s; }
        #clock-live span:nth-child(3) { animation-delay: 0.3s; }
        #clock-live span:nth-child(4) { animation-delay: 0.4s; }
        
        /* 速報コンテナ（変更なし） */
        #breaking-container-inner { background: #e0e0e0; border-radius: 8px; border-left: 8px solid #c00000; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .breaking-row { display: flex; font-weight: bold; }
        .br-row1-header { background: #e0e0e0; color: #000; font-size: 48px; padding: 10px 30px; white-space: nowrap; }
        .br-row1-main { background: #c00000; color: white; font-size: 48px; padding: 10px 30px; flex: 1; text-align: center; }
        .br-row2 { background: #222; color: white; font-size: 42px; padding: 8px 0; display: flex; }
        .br-row2-item { flex: 1; text-align: center; padding: 0 10px; }
        .br-row2-item + .br-row2-item { border-left: 2px solid #555; }
        .br-row3-header { background: #757575; color: white; font-size: 42px; padding: 8px 30px; white-space: nowrap; }
        .br-row3-main { background: #e0e0e0; color: #000; font-size: 42px; padding: 8px 30px; flex: 1; }
    </style>
</head>
<body>
    <div id="ticker-container" class="telop-wrapper">
        <div id="ticker-header">
            <span id="ticker-header-text"></span>
        </div>
        <div id="ticker-scroll-area">
            <div id="ticker-scroll-container">
                <span class="ticker-content"></span>
                <span class="ticker-content" aria-hidden="true"></span>
            </div>
        </div>
        <div id="ticker-clock">
            <span id="clock-time">00:00</span>
            <span id="clock-live">
                <span>L</span><span>I</span><span>V</span><span>E</span>
            </span>
        </div>
        </div>
    
    <div id="breaking-container" class="telop-wrapper">
        <div id="breaking-container-inner">
            <div class="breaking-row">
                <div class="br-row1-header" id="br1-header"></div>
                <div class="br-row1-main" id="br1-main"></div>
            </div>
            <div class="breaking-row br-row2">
                <div class="br-row2-item" id="br2-item1"></div>
                <div class="br-row2-item" id="br2-item2"></div>
                <div class="br-row2-item" id="br2-item3"></div>
                <div class="br-row2-item" id="br2-item4"></div>
            </div>
            <div class="breaking-row">
                <div class="br-row3-header" id="br3-header"></div>
                <div class="br-row3-main" id="br3-main"></div>
                </div>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAhsAbTqQuairo-82A9rxQTazUCGdzdVc4",
            authDomain: "obs-telop-system-7c98c.firebaseapp.com",
            databaseURL: "https://obs-telop-system-7c98c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "obs-telop-system-7c98c",
            storageBucket: "obs-telop-system-7c98c.appspot.com",
            messagingSenderId: "368503557333",
            appId: "1:368503557333:web:409dae2b1cf0c14b31a65c",
            measurementId: "G-VMBCJ2952Z"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('clock-time').textContent = `${hours}:${minutes}`;
        }
        setInterval(updateClock, 1000);
        updateClock();

        function adjustHeaderText() {
            const headerText = document.getElementById('ticker-header-text');
            const header = document.getElementById('ticker-header');
            headerText.style.transform = 'scaleX(1)';
            const maxWidth = header.clientWidth - 40; // padding分を考慮
            if (headerText.scrollWidth > maxWidth) {
                const scale = maxWidth / headerText.scrollWidth;
                headerText.style.transform = `scaleX(${scale})`;
            }
        }

        database.ref('live_data').on('value', (snapshot) => {
            const data = snapshot.val();
            const tickerContainer = document.getElementById('ticker-container');
            const breakingContainer = document.getElementById('breaking-container');
            
            if (!data) {
                tickerContainer.classList.remove('visible');
                breakingContainer.classList.remove('visible');
                return;
            }

            if (data.mode === 'breaking' && data.breaking_content) {
                const content = data.breaking_content;
                // ▼▼▼ 速報のIDに合わせてJSも修正 ▼▼▼
                document.getElementById('br1-header').innerText = content.b_r1_h || '';
                document.getElementById('br1-main').innerText = content.b_r1_m || '';
                document.getElementById('br2-item1').innerHTML = content.b_r2_i1 || '';
                document.getElementById('br2-item2').innerHTML = content.b_r2_i2 || '';
                document.getElementById('br2-item3').innerHTML = content.b_r2_i3 || '';
                document.getElementById('br2-item4').innerHTML = content.b_r2_i4 || '';
                document.getElementById('br3-header').innerText = content.b_r3_h || '';
                document.getElementById('br3-main').innerText = content.b_r3_m || '';
                // ▲▲▲ 速報のIDに合わせてJSも修正 ▲▲▲

                tickerContainer.classList.remove('visible');
                breakingContainer.classList.add('visible');
            } else if (data.mode === 'ticker' && data.ticker_content) {
                const content = data.ticker_content;
                
                // テキストと速度を更新
                const scrollText = content.scrollText || 'コメントをお待ちしています。';
                document.querySelectorAll('.ticker-content').forEach(el => el.innerText = scrollText);
                
                document.getElementById('ticker-header-text').innerText = content.headerText || '東京株式市場';
                
                let duration = 30;
                if (content.scrollSpeed === 'speed-slow') duration = 50;
                if (content.scrollSpeed === 'speed-fast') duration = 15;
                document.getElementById('ticker-scroll-container').style.setProperty('--scroll-duration', `${duration}s`);
                
                // LIVE表示の更新
                document.getElementById('ticker-clock').classList.toggle('show-live', !!content.isLive);
                
                breakingContainer.classList.remove('visible');
                tickerContainer.classList.add('visible');
                
                setTimeout(adjustHeaderText, 100);
            } else {
                 tickerContainer.classList.remove('visible');
                 breakingContainer.classList.remove('visible');
            }
        });
    </script>
</body>
</html>