<!-- control.html (更新後) -->
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>決算速報 送出コントローラー</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <!-- ▼▼▼ 変更点: ハイライト用のCSSを追加 ▼▼▼ -->
    <style>
        .list-item.playing {
            background-color: #34c759 !important;
            color: white;
            font-weight: bold;
        }
        .list-item.playing .handle {
            color: white;
        }
    </style>
</head>
<body>
    <!-- (HTMLの構造に変更はありません) -->

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyAhsAbTqQuairo-82A9rxQTazUCGdzdVc4", authDomain: "obs-telop-system-7c98c.firebaseapp.com", databaseURL: "https://obs-telop-system-7c98c-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "obs-telop-system-7c98c", storageBucket: "obs-telop-system-7c98c.appspot.com", messagingSenderId: "368503557333", appId: "1:368503557333:web:409dae2b1cf0c14b31a65c", measurementId: "G-VMBCJ2952Z" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const playlistControlRef = database.ref('playlist_control');
        const SHOTS_KEY = 'breaking_news_shots_v3';
        const PLAYLIST_KEY = 'breaking_news_playlist_v3';

        const shotFields = ['r1_h', 'r1_m', 'r2_l1', 'r2_v1', 'r2_c1', 'r2_l2', 'r2_v2', 'r2_c2', 'r2_l3', 'r2_v3', 'r2_c3'];
        let playlist = JSON.parse(localStorage.getItem(PLAYLIST_KEY) || '[]');
        let isPlaying = false;
        let nowPlayingIndex = null; // 現在再生中のインデックスを保存する変数

        // ... (getCurrentEditorData, loadDataToEditor, get/saveSavedShots, renderSavedShots は変更なし)

        function renderPlaylist() {
            const list = document.getElementById('playlist-list'); list.innerHTML = '';
            playlist.forEach((shot, index) => {
                const li = document.createElement('li'); li.className = 'list-item';
                // ▼▼▼ 変更点: 再生中なら 'playing' クラスを付与 ▼▼▼
                if (isPlaying && index === nowPlayingIndex) {
                    li.classList.add('playing');
                }
                
                // ... (ハンドル、名前、削除ボタンの作成部分は変更なし) ...
                
                list.appendChild(li);
            });
            localStorage.setItem(PLAYLIST_KEY, JSON.stringify(playlist));
        }

        function updateFirebasePlaylistIfPlaying() {
            if (isPlaying) {
                playlistControlRef.update({ playlist: playlist });
            }
        }
        
        // ... (保存、追加、TAKE、クリア、再生、停止ボタンの処理は変更なし)
        
        // ▼▼▼ 変更点: Firebaseからのデータ受信処理を修正 ▼▼▼
        playlistControlRef.on('value', snap => {
            const data = snap.val() || {};
            isPlaying = data.status === 'playing';
            nowPlayingIndex = data.now_playing_index; // 再生中のインデックスを取得
            
            document.getElementById('playback-status').textContent = isPlaying ? `再生中 (${(nowPlayingIndex || 0) + 1} / ${data.playlist?.length || 0})` : '停止中';
            
            renderPlaylist(); // ハイライトを更新するために再描画
        });
        // ▲▲▲ 変更ここまで ▲▲▲
        
        renderSavedShots();
        renderPlaylist();
    </script>
</body>
</html>