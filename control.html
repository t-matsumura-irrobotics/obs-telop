<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Live Telop Controller</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>ライブテロップ コントローラー</h1>
    <div class="main-grid">
        <div id="on-air-panel" class="panel">
            <h2>ON AIR (現在の表示内容)</h2>
            <div id="on-air-status">OFFLINE</div>
        </div>
        <div id="preview-panel" class="panel">
            <h2>PREVIEW / EDIT</h2>
            <div class="tabs">
                <button id="tab-ticker" class="tab-button active">通常ティッカー</button>
                <button id="tab-breaking" class="tab-button">緊急速報</button>
            </div>

            <div id="ticker-controls" class="tab-content active">
                <label>ヘッダーテキスト</label>
                <input type="text" id="tickerHeaderText" value="東京株式市場">
                
                <label>スクロール速度</label>
                <select id="tickerScrollSpeed">
                    <option value="speed-slow">遅い</option>
                    <option value="speed-normal" selected>普通</option>
                    <option value="speed-fast">速い</option>
                </select>
                
                <label>スクロールテキスト</label>
                <textarea id="tickerScrollText">質問や応援コメントお待ちしています。</textarea>
            </div>

            <div id="breaking-controls" class="tab-content">
                <div class="breaking-grid">
                    <div class="grid-item full-width">
                        <label>速報ヘッダー</label>
                        <input type="text" id="br-r1-h-input" value="速報">
                    </div>
                    <div class="grid-item full-width">
                        <label>速報メイン</label>
                        <input type="text" id="br-r1-m-input" value="関東地方で強い揺れ">
                    </div>
                    <div class="grid-item">
                        <label>情報1</label>
                        <input type="text" id="br-r2-i1-input" value="震源地: 東京湾">
                    </div>
                    <div class="grid-item">
                        <label>情報2</label>
                        <input type="text" id="br-r2-i2-input" value="最大震度: 5強">
                    </div>
                    <div class="grid-item">
                        <label>情報3</label>
                        <input type="text" id="br-r2-i3-input" value="M: 7.1">
                    </div>
                    <div class="grid-item">
                        <label>情報4</label>
                        <input type="text" id="br-r2-i4-input" value="津波の心配なし">
                    </div>
                    <div class="grid-item full-width">
                        <label>補足ヘッダー</label>
                        <input type="text" id="br-r3-h-input" value="[今後の情報]">
                    </div>
                    <div class="grid-item full-width">
                        <label>補足メイン</label>
                        <input type="text" id="br-r3-m-input" value="テレビ・ラジオの情報に注意してください。">
                    </div>
                </div>
            </div>
            <div class="button-group">
                <button id="takeButton" class="btn btn-take">TAKE</button>
                <button id="fallbackButton" class="btn btn-fallback">FALLBACK (TICKER)</button>
            </div>
        </div>
        <div id="shots-panel" class="panel">
             <h2>SAVED SHOTS (速報用)</h2>
             <ul id="shots-list"></ul>
             <div class="save-shot">
                <input type="text" id="shot-name-input" placeholder="下書きの名前...">
                <button id="save-shot-button" class="btn-save">保存</button>
             </div>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
        // --- ▼ここからが追加したJavaScriptです▼ ---

        // ■ 1. Firebaseの初期設定
        const firebaseConfig = {
            apiKey: "AIzaSyAhsAbTqQuairo-82A9rxQTazUCGdzdVc4",
            authDomain: "obs-telop-system-7c98c.firebaseapp.com",
            databaseURL: "https://obs-telop-system-7c98c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "obs-telop-system-7c98c",
            storageBucket: "obs-telop-system-7c98c.appspot.com",
            messagingSenderId: "368503557333",
            appId: "1:368503557333:web:409dae2b1cf0c14b31a65c",
            measurementId: "G-VMBCJ2952Z"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ■ 2. UI要素の取得
        const tabTicker = document.getElementById('tab-ticker');
        const tabBreaking = document.getElementById('tab-breaking');
        const tickerControls = document.getElementById('ticker-controls');
        const breakingControls = document.getElementById('breaking-controls');
        const takeButton = document.getElementById('takeButton');
        const fallbackButton = document.getElementById('fallbackButton');

        // ■ 3. タブ切り替え機能
        tabTicker.addEventListener('click', () => {
            tabTicker.classList.add('active');
            tabBreaking.classList.remove('active');
            tickerControls.classList.add('active');
            breakingControls.classList.remove('active');
        });

        tabBreaking.addEventListener('click', () => {
            tabBreaking.classList.add('active');
            tabTicker.classList.remove('active');
            breakingControls.classList.add('active');
            tickerControls.classList.remove('active');
        });

        // ■ 4. TAKEボタンの機能
        takeButton.addEventListener('click', () => {
            let liveData = {};
            // 表示中のタブに応じて送信するデータを切り替える
            if (tabTicker.classList.contains('active')) {
                liveData = {
                    mode: 'ticker',
                    ticker_content: {
                        headerText: document.getElementById('tickerHeaderText').value,
                        scrollText: document.getElementById('tickerScrollText').value,
                        scrollSpeed: document.getElementById('tickerScrollSpeed').value
                    }
                };
            } else {
                liveData = {
                    mode: 'breaking',
                    breaking_content: {
                        b_r1_h: document.getElementById('br-r1-h-input').value,
                        b_r1_m: document.getElementById('br-r1-m-input').value,
                        b_r2_i1: document.getElementById('br-r2-i1-input').value,
                        b_r2_i2: document.getElementById('br-r2-i2-input').value,
                        b_r2_i3: document.getElementById('br-r2-i3-input').value,
                        b_r2_i4: document.getElementById('br-r2-i4-input').value,
                        b_r3_h: document.getElementById('br-r3-h-input').value,
                        b_r3_m: document.getElementById('br-r3-m-input').value,
                    }
                };
            }
            // Firebaseにデータを送信！
            database.ref('live_data').set(liveData);
        });
        
        // ■ 5. FALLBACKボタンの機能 (強制的にティッカーに戻す)
        fallbackButton.addEventListener('click', () => {
             const liveData = {
                mode: 'ticker',
                ticker_content: {
                    headerText: document.getElementById('tickerHeaderText').value,
                    scrollText: document.getElementById('tickerScrollText').value,
                    scrollSpeed: document.getElementById('tickerScrollSpeed').value
                }
            };
            database.ref('live_data').set(liveData);
        });

        // ■ 6. ON AIRステータスの表示
        const onAirStatus = document.getElementById('on-air-status');
        database.ref('live_data').on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                onAirStatus.textContent = JSON.stringify(data, null, 2);
            } else {
                onAirStatus.textContent = 'OFFLINE';
            }
        });

        // ■ 7. 速報の下書き保存・読込・削除機能
        const saveShotButton = document.getElementById('save-shot-button');
        const shotNameInput = document.getElementById('shot-name-input');
        const shotsList = document.getElementById('shots-list');

        // 保存ボタン
        saveShotButton.addEventListener('click', () => {
            const shotName = shotNameInput.value.trim();
            if (!shotName) {
                alert('下書きの名前を入力してください。');
                return;
            }
            const shotData = {
                name: shotName,
                content: {
                    b_r1_h: document.getElementById('br-r1-h-input').value,
                    b_r1_m: document.getElementById('br-r1-m-input').value,
                    b_r2_i1: document.getElementById('br-r2-i1-input').value,
                    b_r2_i2: document.getElementById('br-r2-i2-input').value,
                    b_r2_i3: document.getElementById('br-r2-i3-input').value,
                    b_r2_i4: document.getElementById('br-r2-i4-input').value,
                    b_r3_h: document.getElementById('br-r3-h-input').value,
                    b_r3_m: document.getElementById('br-r3-m-input').value,
                }
            };
            database.ref('saved_shots').push(shotData);
            shotNameInput.value = '';
        });

        // 保存済みリストの描画
        function renderShots(shots) {
            shotsList.innerHTML = '';
            for (const key in shots) {
                const shot = shots[key];
                const li = document.createElement('li');
                li.className = 'shot-item';
                li.innerHTML = `
                    <span class="shot-name">${shot.name}</span>
                    <div class="shot-actions">
                        <button class="btn-load">読込</button>
                        <button class="btn-delete">削除</button>
                    </div>
                `;
                // 読込ボタンの機能
                li.querySelector('.btn-load').addEventListener('click', () => {
                    const content = shot.content;
                    document.getElementById('br-r1-h-input').value = content.b_r1_h;
                    document.getElementById('br-r1-m-input').value = content.b_r1_m;
                    document.getElementById('br-r2-i1-input').value = content.b_r2_i1;
                    document.getElementById('br-r2-i2-input').value = content.b_r2_i2;
                    document.getElementById('br-r2-i3-input').value = content.b_r2_i3;
                    document.getElementById('br-r2-i4-input').value = content.b_r2_i4;
                    document.getElementById('br-r3-h-input').value = content.b_r3_h;
                    document.getElementById('br-r3-m-input').value = content.b_r3_m;
                    // 自動で速報タブに切り替え
                    tabBreaking.click(); 
                });
                // 削除ボタンの機能
                li.querySelector('.btn-delete').addEventListener('click', () => {
                    if (confirm(`「${shot.name}」を削除しますか？`)) {
                        database.ref('saved_shots/' + key).remove();
                    }
                });
                shotsList.appendChild(li);
            }
        }
        
        // Firebaseから下書きリストを取得して表示
        database.ref('saved_shots').on('value', (snapshot) => {
            renderShots(snapshot.val());
        });

        // --- ▲ここまでが追加したJavaScriptです▲ ---
    </script>
</body>
</html>